<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.yeongju.its.ad.core.mapper.park.apiNewStatus">
	
	<select id="select_List" parameterType="commonMap" resultType="commonMap">
		SELECT T.PARKING_NO, T.P_GOV_NAME, T.P_COMP_NAME, T.PARKING_AREA_CODE
			 , T.AUTO_RESULT_CODE, T.AUTO_RECEIVE_DT, T.AUTO_CAR_NO
			 , T.GPKI_RESULT_CODE, T.GPKI_RECEIVE_DT, T.GPKI_CAR_NO
			 , T.OUT_RESULT_CODE, T.OUT_RECEIVE_DT, T.OUT_CAR_NO
<![CDATA[
			 , CASE WHEN W.CHK_API IN ('CAT01','CAT02') AND T.AUTO_HOUR_DIFF > W.ALERT_CAUT_HOUR THEN '위험'
					WHEN W.CHK_API IN ('CAT01','CAT02') AND T.AUTO_HOUR_DIFF > W.ALERT_WARN_HOUR THEN '주의'
					WHEN W.CHK_API IN ('CAT01','CAT02') AND T.AUTO_HOUR_DIFF < W.ALERT_WARN_HOUR THEN '정상'
					ELSE '' END AS AUTO_STATUS
			 , CASE WHEN W.CHK_API IN ('CAT01','CAT03') AND T.GPKI_HOUR_DIFF > W.ALERT_CAUT_HOUR THEN '위험'
					WHEN W.CHK_API IN ('CAT01','CAT03') AND T.GPKI_HOUR_DIFF > W.ALERT_WARN_HOUR THEN '주의'
					WHEN W.CHK_API IN ('CAT01','CAT03') AND T.GPKI_HOUR_DIFF < W.ALERT_WARN_HOUR THEN '정상'
					ELSE '' END AS GPKI_STATUS
			 , CASE WHEN W.CHK_API IN ('CAT01','CAT04') AND T.OUT_HOUR_DIFF > W.ALERT_CAUT_HOUR THEN '위험'
					WHEN W.CHK_API IN ('CAT01','CAT04') AND T.OUT_HOUR_DIFF > W.ALERT_WARN_HOUR THEN '주의'
					WHEN W.CHK_API IN ('CAT01','CAT04') AND T.OUT_HOUR_DIFF < W.ALERT_WARN_HOUR THEN '정상'
					ELSE '' END AS OUT_STATUS
]]>
		  FROM (
		  		SELECT P.PARKING_NO, G.P_GOV_NAME, C.P_COMP_NAME, P.PARKING_AREA_CODE
					 , EAA.RESULT_CODE AS AUTO_RESULT_CODE
					 , EAA.RECEIVE_DT AS AUTO_RECEIVE_DT
					 , EAA.CAR_NUMBER_RECV AS AUTO_CAR_NO
					 , SUBSTR(DATE_FORMAT(NOW() - STR_TO_DATE(EAA.RECEIVE_DT, '%Y/%m%d %H:%i:%s.%f'), '%Y-%m-%d %H:%i:%s'), 12, 2) AS AUTO_HOUR_DIFF
					 , EGA.RESULT_CODE AS GPKI_RESULT_CODE
					 , EGA.RECEIVE_DT AS GPKI_RECEIVE_DT
					 , EGA.CAR_NUMBER_RECV AS GPKI_CAR_NO
					 , SUBSTR(DATE_FORMAT(NOW() - STR_TO_DATE(EGA.RECEIVE_DT, '%Y/%m%d %H:%i:%s.%f'), '%Y-%m-%d %H:%i:%s'), 12, 2) AS GPKI_HOUR_DIFF
					 , OCA.RESULT_CODE AS OUT_RESULT_CODE
					 , OCA.RECEIVE_DT AS OUT_RECEIVE_DT
					 , OCA.CAR_NUMBER_RECV AS OUT_CAR_NO
					 , SUBSTR(DATE_FORMAT(NOW() - STR_TO_DATE(OCA.RECEIVE_DT, '%Y/%m%d %H:%i:%s.%f'), '%Y-%m-%d %H:%i:%s'), 12, 2) AS OUT_HOUR_DIFF
				  FROM T_PARKING_INFO P
				 INNER JOIN T_PARKING_GOV_INFO G
					ON P.P_GOV_CODE = G.P_GOV_CODE
				 INNER JOIN T_PARKING_COMP_INFO C
					ON P.P_COMP_CODE = C.P_COMP_CODE
					
				  LEFT OUTER JOIN ( SELECT E.PARKING_AREA_CODE, E.CAR_NUMBER_RECV, E.RESULT_CODE, E.RECEIVE_DT
								FROM T_ENTER_AUTOPAY_API_HISTORY E
							   INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
											  FROM T_ENTER_AUTOPAY_API_HISTORY
										     GROUP BY PARKING_AREA_CODE
								 ) EM
								ON E.PARKING_AREA_CODE = EM.PARKING_AREA_CODE
							   AND E.RECEIVE_DT = EM.RECEIVE_DT
					 ) EAA
					ON P.PARKING_AREA_CODE = EAA.PARKING_AREA_CODE
				
				  LEFT OUTER JOIN ( SELECT EG.PARKING_AREA_CODE, EG.CAR_NUMBER_RECV, EG.RESULT_CODE, EG.RECEIVE_DT
							    FROM T_ENTER_GPKI_API_HISTORY EG
							   INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
											  FROM T_ENTER_GPKI_API_HISTORY
										     GROUP BY PARKING_AREA_CODE
								 ) EGM
								ON EG.PARKING_AREA_CODE = EGM.PARKING_AREA_CODE
							   AND EG.RECEIVE_DT = EGM.RECEIVE_DT
					 ) EGA
					ON P.PARKING_AREA_CODE = EGA.PARKING_AREA_CODE
					
				  LEFT OUTER JOIN ( SELECT O.PARKING_AREA_CODE, O.CAR_NUMBER_RECV, O.RESULT_CODE, O.RECEIVE_DT
							    FROM T_OUT_CAR_API_HISTORY O
							   INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
											  FROM T_OUT_CAR_API_HISTORY
										     GROUP BY PARKING_AREA_CODE
								 ) OM
								ON O.PARKING_AREA_CODE = OM.PARKING_AREA_CODE
							   AND O.RECEIVE_DT = OM.RECEIVE_DT
					 ) OCA
					ON P.PARKING_AREA_CODE = OCA.PARKING_AREA_CODE
					
			     WHERE P.API_VER_GUBN = 2
				<if test="kParkingNo neq null and kParkingNo neq ''">
				   AND P.PARKING_NO = #{kParkingNo}
				</if>
			 ) T
		  LEFT OUTER JOIN T_WARNING_SMS_STATUS W
			ON T.PARKING_NO  = W.PARKING_NO
		 ORDER BY T.PARKING_NO
	</select>
	
	<select id="select_lastReceive" parameterType="commonMap" resultType="commonMap">
		SELECT IFNULL(DATE_FORMAT(EAA.RECEIVE_DT, '%Y-%m-%d %H:%i:%s'), '') AS AUTO_RECEIVE_DT
			 , IFNULL(DATE_FORMAT(TIMEDIFF(NOW(), EAA.RECEIVE_DT),'%H:%i:%s'), '') AS AUTO_TIME_DIFF

			 , IFNULL(DATE_FORMAT(EGA.RECEIVE_DT, '%Y-%m-%d %H:%i:%s'), '') AS GPKI_RECEIVE_DT
			 , IFNULL(DATE_FORMAT(TIMEDIFF(NOW(), EGA.RECEIVE_DT),'%H:%i:%s'), '') AS GPKI_TIME_DIFF

			 , IFNULL(DATE_FORMAT(OCA.RECEIVE_DT, '%Y-%m-%d %H:%i:%s'), '') AS OUT_RECEIVE_DT
			 , IFNULL(DATE_FORMAT(TIMEDIFF(NOW(), OCA.RECEIVE_DT),'%H:%i:%s'), '') AS OUT_TIME_DIFF
			 
		  FROM T_PARKING_INFO P
		  LEFT OUTER JOIN ( 
		  			SELECT E.PARKING_AREA_CODE, E.RECEIVE_DT
					  FROM T_ENTER_AUTOPAY_API_HISTORY E
					 INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
									FROM T_ENTER_AUTOPAY_API_HISTORY
								   GROUP BY PARKING_AREA_CODE
						 ) EM
						ON E.PARKING_AREA_CODE = EM.PARKING_AREA_CODE
					   AND E.RECEIVE_DT = EM.RECEIVE_DT
			 ) EAA
			ON P.PARKING_AREA_CODE = EAA.PARKING_AREA_CODE
		
		  LEFT OUTER JOIN ( 
		  			SELECT EG.PARKING_AREA_CODE, EG.RECEIVE_DT
					  FROM T_ENTER_GPKI_API_HISTORY EG
					 INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
									FROM T_ENTER_GPKI_API_HISTORY
								   GROUP BY PARKING_AREA_CODE
						 ) EGM
						ON EG.PARKING_AREA_CODE = EGM.PARKING_AREA_CODE
					   AND EG.RECEIVE_DT = EGM.RECEIVE_DT
			 ) EGA
			ON P.PARKING_AREA_CODE = EGA.PARKING_AREA_CODE
			
		  LEFT OUTER JOIN ( 
		  			SELECT O.PARKING_AREA_CODE, O.RECEIVE_DT
					  FROM T_OUT_CAR_API_HISTORY O
					 INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
									FROM T_OUT_CAR_API_HISTORY
								   GROUP BY PARKING_AREA_CODE
						 ) OM
						ON O.PARKING_AREA_CODE = OM.PARKING_AREA_CODE
					   AND O.RECEIVE_DT = OM.RECEIVE_DT
			 ) OCA
			ON P.PARKING_AREA_CODE = OCA.PARKING_AREA_CODE
		 WHERE P.PARKING_NO = #{hParkingNo}
	
	</select>
	
	<select id="select_parkInfo" parameterType="commonMap" resultType="commonMap">
		SELECT CONCAT(PARKING_NAME , '(' , PARKING_AREA_CODE , ')') AS TEXT
		     , PARKING_NO VALUE
		  FROM T_PARKING_INFO
		 WHERE 1=1
		   AND USE_YN = 'Y'
	</select>
</mapper>