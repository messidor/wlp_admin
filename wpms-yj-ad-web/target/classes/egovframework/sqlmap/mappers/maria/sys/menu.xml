<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.yeongju.its.ad.core.mapper.sys.menu">

	<select id="select_newKey" parameterType="commonMap" resultType="commonMap">
		SELECT IFNULL(MAX(MENU_ID), 0) + 1 AS NEW_MENU_ID
          FROM T_SYS_MENU_INFO
	</select>

	<select id="select_tree" parameterType="commonMap" resultType="commonMap">
		SELECT Z.PARENT, Z.ID, Z.TEXT, Z.CODE_TYPE
          FROM (
                    SELECT '#' AS PARENT
                         , 1 AS ID
                         , '전체 메뉴' TEXT
                         , 0 AS MENU_ORDER
                         , 'F' CODE_TYPE
                      FROM DUAL
                     UNION ALL
                    SELECT A.PARENT_MENU_ID AS PARENT
                         , A.MENU_ID AS ID
                         , IF(A.MENU_NAME IS NULL, ' ', CONCAT(A.MENU_NAME , ' [' , IFNULL(B.MENU_CNT, 0) , ']')) AS TEXT
                         , A.MENU_ORDER
                         , A.CODE_TYPE
                      FROM T_SYS_MENU_INFO A
                      LEFT OUTER JOIN (
                             SELECT PARENT_MENU_ID, COUNT(MENU_ID) AS MENU_CNT
                               FROM T_SYS_MENU_INFO
                              GROUP BY PARENT_MENU_ID
                         ) B
                        ON A.MENU_ID = B.PARENT_MENU_ID
                     WHERE A.USE_YN = 'Y'
             ) Z
         ORDER BY Z.MENU_ORDER		 
	</select>

	<select id="select_list" parameterType="commonMap" resultType="commonMap">
		SELECT A.PARENT_MENU_ID
             , A.MENU_ID
             , IFNULL(A.MENU_NAME, '') AS MENU_NAME
             , IFNULL(A.MENU_URL, '') AS MENU_URL
             , IFNULL(A.MENU_ICON, '') AS MENU_ICON
             , A.CODE_TYPE
             , A.USE_YN
             , B.USER_NAME AS MOD_ID
             , DATE_FORMAT(A.MOD_DT, '%Y-%m-%d %H:%i:%s') MOD_DT
             , '' AS STATE_COL
          FROM T_SYS_MENU_INFO A
          LEFT OUTER JOIN T_USER_INFO B
            ON A.MOD_ID = B.USER_ID
         WHERE A.PARENT_MENU_ID = #{hMenuId}
         
         <if test="kMenuName neq null and kMenuName neq ''" >
			AND A.MENU_NAME LIKE '%${kMenuName}%'
		</if>
		 
		<if test="kUseYn neq null and kUseYn neq ''" >
			AND A.USE_YN = #{kUseYn}
		</if>
		
         ORDER BY A.MENU_ORDER
	</select>
	
	<insert id="insert_data">
		INSERT INTO T_SYS_MENU_INFO (
			MENU_ID, PARENT_MENU_ID, MENU_NAME, MENU_URL
          , MENU_SBC, MENU_ICON, MENU_ORDER, CODE_TYPE_PARENT, CODE_TYPE
		  , USE_YN_PARENT, USE_YN, LANG_CODE, REG_ID, REG_DT
          , MOD_ID, MOD_DT
		) VALUES (
			#{newMenuId}, #{hMenuId}, #{grdMenuName}, #{grdMenuUrl}
		  , NULL, #{grdMenuIcon}, #{maxIdx}+1, 'MENU_GUBN', #{grdCodeType}
          , 'USE_YN', #{grdUseYn}, NULL, #{userId}, NOW()
		  , #{userId}, NOW()
		)
	</insert>
	
	<update id="update_data">
		UPDATE T_SYS_MENU_INFO
           SET MENU_NAME = #{grdMenuName}
             , MENU_URL = #{grdMenuUrl}
             , MENU_ICON = #{grdMenuIcon}
             , CODE_TYPE = #{grdCodeType}
             , USE_YN = #{grdUseYn}
             , MOD_ID = #{userId}
             , MOD_DT = NOW()
         WHERE MENU_ID = #{grdMenuId}
	</update>
	
	<delete id="delete_data">
		DELETE FROM T_SYS_MENU_INFO
         WHERE MENU_ID = #{grdMenuId}
	</delete>
	
	<delete id="delete_data2">
		DELETE FROM T_SYS_MENU_BTN
         WHERE MENU_ID = #{grdMenuId}
	</delete>
	
	<delete id="delete_data3">
		DELETE FROM T_SYS_MENU_BTN_COND
         WHERE MENU_ID = #{grdMenuId}
	</delete>
	
	<delete id="delete_data4">
		DELETE FROM T_SYS_MENU_BTN_ROLE_INFO
         WHERE MENU_ID = #{grdMenuId}
	</delete>
	
	<!-- 부모코드 업데이트 -->
	<update id="update_parentMenuId">
		UPDATE T_SYS_MENU_INFO
           SET PARENT_MENU_ID = #{parentMenuId}
         WHERE MENU_ID = #{menuId}
	</update>
	
	<!-- 메뉴순서 업데이트 -->
<!-- 	<update id="update_eachMenuOrder"> -->
<!-- 		UPDATE T_SYS_MENU_INFO -->
<!--            SET MENU_ORDER = #{index} + 1 -->
<!--          WHERE MENU_ID = #{grdMenuId} -->
<!-- 	</update> -->
	
	<!-- 전체 메뉴 정렬 순서 업데이트 -->
	<update id="update_menuOrder">
		UPDATE T_SYS_MENU_INFO A
		 INNER JOIN (
			SELECT M.PARENT_MENU_ID, M.MENU_ID, M.MENU_ORDER,
				   ROW_NUMBER() OVER(PARTITION BY M.PARENT_MENU_ID ORDER BY M.MENU_ORDER ASC) AS NEW_ORDER
			<![CDATA[, CASE WHEN IFNULL(D2.CHILD_CNT, 0) < 1 THEN D.CODE_TYPE ELSE 'F' END AS CODE_TYPE]]>
			  FROM T_SYS_MENU_INFO D
			  LEFT OUTER JOIN T_SYS_MENU_INFO M
				ON D.MENU_ID = M.MENU_ID
			  LEFT OUTER JOIN (
						SELECT PARENT_MENU_ID, COUNT(*) AS CHILD_CNT
						  FROM T_SYS_MENU_INFO
						 GROUP BY PARENT_MENU_ID
				 ) D2
				ON D.MENU_ID = D2.PARENT_MENU_ID
			 ) B
			ON A.MENU_ID = B.MENU_ID
		 
		   SET A.MENU_ORDER = B.NEW_ORDER
			 , A.CODE_TYPE = B.CODE_TYPE
			 , A.MOD_DT = NOW()
	</update>
</mapper>