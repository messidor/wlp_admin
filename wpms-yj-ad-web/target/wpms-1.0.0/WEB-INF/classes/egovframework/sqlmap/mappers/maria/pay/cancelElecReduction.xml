<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.yeongju.its.ad.core.mapper.pay.cancelElecReduction">


	<select id="select_parkingInfo" parameterType="commonMap" resultType="commonMap">
		SELECT PARKING_NO VALUE, PARKING_NAME TEXT
	      FROM T_PARKING_INFO
         WHERE 1=1
		<if test="userParkingGov neq null and userParkingGov neq ''" >
		   AND P_GOV_CODE = #{userParkingGov}
		</if>
	</select>
	
	<select id="Select_List" parameterType="commonMap" resultType="commonMap">
		SELECT E.ELEC_APPLY_CODE, E.MEMBER_ID, E.APPLY_DT
			 , E.MEMBER_ID, E.PARKING_NO, P.PARKING_NAME
			 , E.CAR_NO, E.ELECT_DATE
			 , C1.CODE_NAME1 AS CONFIRM_GUBN
			 , C2.CODE_NAME1 AS CANCEL_GUBN_NAME
			 , IFNULL(UI.USER_NAME, MI.MEMBER_NAME) AS CANCEL_NAME
			 , E.CANCEL_DT
			 , E.CANCEL_GUBN
			 , CASE WHEN E.CANCEL_GUBN = 'N' THEN '취소' ELSE '' END AS POP_CANCEL
		  FROM T_ELEC_REDUCTION E
		 INNER JOIN T_PARKING_INFO P
			ON E.PARKING_NO = P.PARKING_NO
		  LEFT OUTER JOIN T_SYS_COMCODE C1
			ON E.CONFIRM_GUBN_PARENT = C1.PARENT_CODE_ID
		   AND E.CONFIRM_GUBN = C1.CODE_ID
		  LEFT OUTER JOIN T_SYS_COMCODE C2
			ON E.CANCEL_GUBN_PARENT = C2.PARENT_CODE_ID
		   AND E.CANCEL_GUBN = C2.CODE_ID
		  LEFT OUTER JOIN T_USER_INFO UI
			ON E.CANCEL_ID = UI.USER_ID
		  LEFT OUTER JOIN T_MEMBER_INFO MI
			ON E.CANCEL_ID = MI.MEMBER_ID
		 WHERE E.CONFIRM_GUBN != 'Y'
	    <if test="startDate neq null and startDate neq ''" >
			AND DATE_FORMAT(E.APPLY_DT, '%Y-%m-%d') BETWEEN #{startDate} AND #{endDate}
		</if> 
		<if test="kParkingGovCode neq null and kParkingGovCode neq ''" >
			AND P.P_GOV_CODE = #{kParkingGovCode}
		</if>  
	    <if test="kParkingNo neq null and kParkingNo neq ''" >
			AND E.PARKING_NO = #{kParkingNo}
		</if>
		<if test="kCarNumber neq null and kCarNumber neq ''" >
			AND E.CAR_NO LIKE '%${kCarNumber}%'
		</if>
		<if test="kConfirmGubn neq null and kConfirmGubn neq ''" >
			AND E.CONFIRM_GUBN = #{kConfirmGubn} 
		</if>
		<if test="kCancelGubn neq null and kCancelGubn neq ''" >
			AND E.CANCEL_GUBN = #{kCancelGubn} 
		</if>
		
		ORDER BY E.APPLY_DT DESC
		
	</select>
	
	<select id="Select_PopupList" parameterType="commonMap" resultType="commonMap">
		SELECT DATE_FORMAT(E.APPLY_DT, '%Y-%m-%d %H:%i:%s') APPLY_DT
			 , E.CAR_NO
			 , P.PARKING_NAME
			 , DATE_FORMAT(STR_TO_DATE(E.ELECT_DATE, '%Y%m%d%H%i%s'), '%Y-%m-%d %H:%i:%s') ELECT_DATE
			 , C1.CODE_NAME1 AS CONFIRM_GUBN
			 , UI.USER_NAME AS CANCEL_NAME
			 , DATE_FORMAT(E.CANCEL_DT, '%Y-%m-%d %H:%i:%s') CANCEL_DT
		     , CASE WHEN F.FILE_KEY IS NULL THEN '' ELSE CONCAT(F.FILE_PATH ,F.FILE_NAME , '.' , F.FILE_EXT) END AS FILE_NAME
			 , CASE WHEN F.FILE_KEY IS NULL THEN '' ELSE CONCAT(F.FILE_NAME , '.' , F.FILE_EXT) END AS NAME
			 , CASE WHEN F.FILE_KEY IS NULL THEN '' ELSE CONCAT(F.ORIG_FILE_NAME , '.' , F.FILE_EXT) END AS DISP_FILE_NAME
			 , IFNULL(F.FILE_KEY, '') AS FILE_KEY
		     , IFNULL(F.MIME_TYPE, '') AS MIME_TYPE
		     , E.FILE_REL_KEY
		     , E.CANCEL_GUBN
		     , C2.CODE_NAME1 AS CANCEL_GUBN_NAME
		     , E.CANCEL_REASON
		  FROM T_ELEC_REDUCTION E
		 INNER JOIN T_PARKING_INFO P
			ON E.PARKING_NO = P.PARKING_NO
		  LEFT OUTER JOIN T_SYS_COMCODE C1
			ON E.CONFIRM_GUBN_PARENT = C1.PARENT_CODE_ID
		   AND E.CONFIRM_GUBN = C1.CODE_ID
		  LEFT OUTER JOIN T_SYS_COMCODE C2
			ON E.CANCEL_GUBN_PARENT = C2.PARENT_CODE_ID
		   AND E.CANCEL_GUBN = C2.CODE_ID
		  LEFT OUTER JOIN T_USER_INFO UI
			ON E.CANCEL_ID = UI.USER_ID
		  LEFT OUTER JOIN T_FILE_RELATION R
		    ON E.FILE_REL_KEY = R.FILE_REL_KEY
	      LEFT OUTER JOIN T_FILE_INFO F
		    ON R.FILE_KEY = F.FILE_KEY
		 WHERE E.ELEC_APPLY_CODE = #{hElecApplyCode}
		   AND E.CAR_NO = #{hCarNo}
		   AND E.MEMBER_ID = #{hMemberId}
	</select>
	
	<update id="Update_elecReductionCancel">
		UPDATE T_ELEC_REDUCTION
		   SET CANCEL_GUBN = 'Y'
			 , CANCEL_ID = #{userId}
			 , CANCEL_DT = NOW()
			 , CANCEL_REASON = #{cancelReason}
		 WHERE ELEC_APPLY_CODE = #{hElecApplyCode}
		   AND CAR_NO = #{hCarNo}
		   AND MEMBER_ID = #{memberId}
	</update>

</mapper>