<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.yeongju.its.ad.core.mapper.park.apiStatus">
	
	<select id="select_List" parameterType="commonMap" resultType="commonMap">
		SELECT T.PARKING_NO, T.P_GOV_NAME, T.P_COMP_NAME, T.PARKING_AREA_CODE
			 , T.ENTER_RESULT_CODE, T.ENTER_RECEIVE_DT, T.ENTER_CAR_NO
			 , T.OUT_RESULT_CODE, T.OUT_RECEIVE_DT, T.OUT_CAR_NO
<![CDATA[
			 , CASE WHEN W.CHK_API IN ('CAT01','CAT02') AND T.ENTER_HOUR_DIFF > W.ALERT_CAUT_HOUR THEN '위험'
					WHEN W.CHK_API IN ('CAT01','CAT02') AND T.ENTER_HOUR_DIFF > W.ALERT_WARN_HOUR THEN '주의'
					WHEN W.CHK_API IN ('CAT01','CAT02') AND T.ENTER_HOUR_DIFF < W.ALERT_WARN_HOUR THEN '정상'
					ELSE '' END AS ENTER_STATUS

			 , CASE WHEN W.CHK_API IN ('CAT01','CAT04') AND T.OUT_HOUR_DIFF > W.ALERT_CAUT_HOUR THEN '위험'
					WHEN W.CHK_API IN ('CAT01','CAT04') AND T.OUT_HOUR_DIFF > W.ALERT_WARN_HOUR THEN '주의'
					WHEN W.CHK_API IN ('CAT01','CAT04') AND T.OUT_HOUR_DIFF < W.ALERT_WARN_HOUR THEN '정상'
					ELSE '' END AS OUT_STATUS
]]>
		  FROM (
		  		SELECT P.PARKING_NO, G.P_GOV_NAME, C.P_COMP_NAME, P.PARKING_AREA_CODE
					 , EA.RESULT_CODE AS ENTER_RESULT_CODE
					 , EA.RECEIVE_DT AS ENTER_RECEIVE_DT
					 , EA.CAR_NUMBER_RECV AS ENTER_CAR_NO
					 , SUBSTR(DATE_FORMAT(NOW() - STR_TO_DATE(EA.RECEIVE_DT, '%Y/%m%d %H:%i:%s.%f'), '%Y-%m-%d %H:%i:%s'), 12, 2) AS ENTER_HOUR_DIFF
					 , OA.RESULT_CODE AS OUT_RESULT_CODE
					 , OA.RECEIVE_DT AS OUT_RECEIVE_DT
					 , OA.CAR_NUMBER_RECV AS OUT_CAR_NO
					 , SUBSTR(DATE_FORMAT(NOW() - STR_TO_DATE(OA.RECEIVE_DT, '%Y/%m%d %H:%i:%s.%f'), '%Y-%m-%d %H:%i:%s'), 12, 2) AS OUT_HOUR_DIFF
				  FROM T_PARKING_INFO P
				 INNER JOIN T_PARKING_GOV_INFO G
					ON P.P_GOV_CODE = G.P_GOV_CODE
				 INNER JOIN T_PARKING_COMP_INFO C
					ON P.P_COMP_CODE = C.P_COMP_CODE

				  LEFT OUTER JOIN ( SELECT E.PARKING_AREA_CODE, E.CAR_NUMBER_RECV, E.RESULT_CODE, E.RECEIVE_DT
								FROM T_ENTER_API_HISTORY E
							   INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
											  FROM T_ENTER_API_HISTORY
										     GROUP BY PARKING_AREA_CODE
								 ) EM
								ON E.PARKING_AREA_CODE = EM.PARKING_AREA_CODE
							   AND E.RECEIVE_DT = EM.RECEIVE_DT
					 ) EA
					ON P.PARKING_NO = EA.PARKING_AREA_CODE

				  LEFT OUTER JOIN ( SELECT O.PARKING_AREA_CODE, O.CAR_NUMBER_RECV, O.RESULT_CODE, O.RECEIVE_DT
							    FROM T_OUT_API_HISTORY O
							   INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
											  FROM T_OUT_API_HISTORY
										     GROUP BY PARKING_AREA_CODE
								 ) OM
								ON O.PARKING_AREA_CODE = OM.PARKING_AREA_CODE
							   AND O.RECEIVE_DT = OM.RECEIVE_DT
					 ) OA
					ON P.PARKING_AREA_CODE = OA.PARKING_AREA_CODE
					
			     WHERE P.API_VER_GUBN = 1
				<if test="kParkingNo neq null and kParkingNo neq ''">
				   AND P.PARKING_NO = #{kParkingNo}
				</if>
			 ) T
		  LEFT OUTER JOIN T_WARNING_SMS_STATUS W
			ON T.PARKING_NO  = W.PARKING_NO
		 ORDER BY T.PARKING_NO
	</select>
	
	<select id="select_lastReceive" parameterType="commonMap" resultType="commonMap">
		SELECT IFNULL(DATE_FORMAT(EA.RECEIVE_DT, '%Y-%m-%d %H:%i:%s'), '') AS ENTER_RECEIVE_DT
			 , IFNULL(DATE_FORMAT(TIMEDIFF(NOW(), EA.RECEIVE_DT),'%H:%i:%s'), '') AS ENTER_TIME_DIFF
			 
			 , IFNULL(DATE_FORMAT(OA.RECEIVE_DT, '%Y-%m-%d %H:%i:%s'), '') AS OUT_RECEIVE_DT
			 , IFNULL(DATE_FORMAT(TIMEDIFF(NOW(), OA.RECEIVE_DT),'%H:%i:%s'), '') AS OUT_TIME_DIFF

		  FROM T_PARKING_INFO P
		  LEFT OUTER JOIN ( 
		  			SELECT E.PARKING_AREA_CODE, E.RECEIVE_DT
					  FROM T_ENTER_API_HISTORY E
					 INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
									FROM T_ENTER_API_HISTORY
								   GROUP BY PARKING_AREA_CODE
						 ) EM
						ON E.PARKING_AREA_CODE = EM.PARKING_AREA_CODE
					   AND E.RECEIVE_DT = EM.RECEIVE_DT
			 ) EA
			ON P.PARKING_AREA_CODE = EA.PARKING_AREA_CODE

		  LEFT OUTER JOIN ( 
		  			SELECT O.PARKING_AREA_CODE, O.RECEIVE_DT
					  FROM T_OUT_API_HISTORY O
					 INNER JOIN ( SELECT PARKING_AREA_CODE, MAX(RECEIVE_DT) RECEIVE_DT
									FROM T_OUT_API_HISTORY
								   GROUP BY PARKING_AREA_CODE
						 ) OM
						ON O.PARKING_AREA_CODE = OM.PARKING_AREA_CODE
					   AND O.RECEIVE_DT = OM.RECEIVE_DT
			 ) OA
			ON P.PARKING_AREA_CODE = OA.PARKING_AREA_CODE
		 WHERE P.PARKING_NO = #{hParkingNo}
	
	</select>
	
	<select id="select_parkInfo" parameterType="commonMap" resultType="commonMap">
		SELECT CONCAT(PARKING_NAME , '(' , PARKING_AREA_CODE, ')') AS TEXT
		     , PARKING_NO VALUE
		  FROM T_PARKING_INFO
		 WHERE API_VER_GUBN = 1
		   AND USE_YN = 'Y'
	</select>
</mapper>