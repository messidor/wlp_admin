<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.yeongju.its.ad.core.mapper.sys.dept">

	<select id="select_deptComboData" parameterType="commonMap" resultType="commonMap">
		 WITH RECURSIVE CTE (PARENT_DEPT_ID, DEPT_ID, DEPT_NAME_STR, DEPT_ORDER_STR, DEPTH) AS (
                SELECT A.PARENT_DEPT_ID, A.DEPT_ID
                     , A.DEPT_NAME AS DEPT_NAME_STR
                     , LPAD(A.DEPT_ORDER, 4, '0') AS DEPT_ORDER_STR
                     , 1 AS DEPTH
                  FROM T_SYS_DEPT A
                 WHERE A.USE_YN = 'Y'
                   AND A.PARENT_DEPT_ID = 'DEPT'
                 UNION ALL
                SELECT D.PARENT_DEPT_ID, D.DEPT_ID
                     , CONCAT(LPAD('', (C.DEPTH + 1) * 2, '') , '└ ' , D.DEPT_NAME) AS DEPT_NAME_STR
                     , CONCAT(C.DEPT_ORDER_STR, D.DEPT_ID) AS DEPT_ORDER_STR
                     , C.DEPTH + 1 AS DEPTH
                  FROM CTE C
                 INNER JOIN T_SYS_DEPT D
                    ON C.DEPT_ID = D.PARENT_DEPT_ID
            )
       SELECT DEPT_ID AS VALUE, DEPT_NAME_STR AS TEXT
         FROM CTE C
        ORDER BY C.DEPT_ORDER_STR
	</select>


	<select id="select_newKey" parameterType="commonMap" resultType="commonMap">
		SELECT FN_MAKE_KEY('DEPT_CODE') AS GRD_DEPT_ID
	</select>

	<update id="update_order" parameterType="commonMap">
		UPDATE T_SYS_DEPT
		   SET DEPT_ORDER = #{index} + 1
		 WHERE DEPT_ID = #{grdDeptId}
	</update>
	
	<select id="select_tree" parameterType="commonMap" resultType="commonMap">
		SELECT Z.PARENT, Z.ID, Z.TEXT, Z.CODE_TYPE
          FROM (
                 SELECT '#' AS PARENT
                      , 'DEPT' AS ID
                      , '부서' AS TEXT
                      , 0 DEPT_ORDER
                      , 'F' AS CODE_TYPE
                   FROM DUAL
                  UNION
                 SELECT A.PARENT_DEPT_ID AS PARENT
                      , A.DEPT_ID AS ID
                      , CONCAT(A.DEPT_NAME , ' [' , IFNULL(B.DEPT_CNT, 0) , ']') AS TEXT
                      , A.DEPT_ORDER
                      , A.CODE_TYPE AS CODE_TYPE
                   FROM T_SYS_DEPT A
                   LEFT OUTER JOIN (
                                     SELECT PARENT_DEPT_ID, COUNT(DEPT_ID) AS DEPT_CNT
                                       FROM T_SYS_DEPT
                                      GROUP BY PARENT_DEPT_ID
                                 ) B
                     ON A.DEPT_ID = B.PARENT_DEPT_ID
                  WHERE A.USE_YN = 'Y'
                    AND A.CODE_TYPE = 'F'
             ) Z
    	 ORDER BY Z.DEPT_ORDER
	</select>

	<select id="select_list" parameterType="commonMap" resultType="commonMap">
		SELECT A.PARENT_DEPT_ID, A.DEPT_ID
             , A.DEPT_NAME, A.DEPT_DESC, A.CODE_TYPE, A.USE_YN, B.USER_NAME MOD_ID
             , DATE_FORMAT(A.MOD_DT, '%Y-%m-%d %H:%i:%s') MOD_DT
             , ' ' STATE_COL
          FROM T_SYS_DEPT A
          LEFT OUTER JOIN T_USER_INFO B
            ON A.MOD_ID = B.USER_ID
         WHERE A.PARENT_DEPT_ID = IF(#{hDeptId} = '',  '-1', #{hDeptId})
         
        <if test="kDeptName neq null and kDeptName neq ''" >
			AND A.DEPT_NAME LIKE '%${kDeptName}%'
		</if>
		
		<if test="kUseYn neq null and kUseYn neq ''" >
			AND A.USE_YN = #{kUseYn}
		</if>
         
         ORDER BY A.DEPT_ORDER
	</select>
	
	<insert id="insert_dept">
		INSERT INTO T_SYS_DEPT(
				    PARENT_DEPT_ID, DEPT_ID, DEPT_NAME, DEPT_DESC
                  , CODE_TYPE_PARENT, CODE_TYPE, USE_YN_PARENT, USE_YN, REG_ID
				  , REG_DT, MOD_ID, MOD_DT
	       ) VALUES (#{parentDeptId}, #{grdDeptId}, #{grdDeptName}, #{grdDeptDesc}
                  , 'CODE_TYPE', #{grdCodeType}, 'USE_YN', #{grdUseYn}, #{userId}
                  , NOW(), #{userId}, NOW()
		   )
	</insert>

	<update id="update_dept">
		UPDATE T_SYS_DEPT
		   SET DEPT_NAME = #{grdDeptName}
		     , DEPT_DESC = #{grdDeptDesc}
		     , CODE_TYPE = #{grdCodeType}
		     , USE_YN = #{grdUseYn}
		     , MOD_ID = #{userId}
		     , MOD_DT = NOW()
		 WHERE DEPT_ID = #{grdDeptId}
	</update>

	<update id="update_dept2">
		UPDATE T_SYS_DEPT A, (
		            WITH RECURSIVE CTE AS (
		                SELECT PARENT_DEPT_ID, DEPT_ID, 'EX' AS CHK_COL
		                  FROM T_SYS_DEPT
		                 WHERE PARENT_DEPT_ID = #{grdParentDeptId}
		                   AND DEPT_ID = #{grdDeptId}
		                 UNION ALL
		                SELECT A.PARENT_DEPT_ID, A.DEPT_ID, 'IN' AS CHK_COL
		                  FROM T_SYS_DEPT A
		                 INNER JOIN CTE C
		                    ON A.PARENT_DEPT_ID = C.DEPT_ID
		            )
		            SELECT PARENT_DEPT_ID, DEPT_ID
		              FROM CTE
		             WHERE CHK_COL = 'IN'
		       ) C
		   SET A.USE_YN = #{grdUseYn}
		 WHERE A.DEPT_ID = C.DEPT_ID
	</update>

	<update id="update_dept3">
		UPDATE T_USER_INFO A
		  JOIN (
			WITH RECURSIVE CTE AS (
				SELECT PARENT_DEPT_ID, DEPT_ID
				  FROM T_SYS_DEPT
				 WHERE PARENT_DEPT_ID = #{grdParentDeptId}
				   AND DEPT_ID = #{grdDeptId}
				 UNION ALL
				SELECT A.PARENT_DEPT_ID, A.DEPT_ID
				  FROM T_SYS_DEPT A
				 INNER JOIN CTE C ON A.PARENT_DEPT_ID = C.DEPT_ID
				 )
			SELECT DEPT_ID 
			  FROM CTE
			 ) C 
			ON A.DEPT_ID = C.DEPT_ID
		   SET A.DEPT_ID = ''
	</update>

	<delete id="delete_dept">
		DELETE FROM T_SYS_DEPT
		 WHERE DEPT_ID = #{grdDeptId}
	</delete>

	<update id="delete_dept2">
		UPDATE T_USER_INFO A, (
		            WITH RECURSIVE CTE AS (
		                SELECT #{grdParentDeptId} AS PARENT_DEPT_ID
		                     , #{grdDeptId} AS DEPT_ID
		                 UNION ALL
		                SELECT A.PARENT_DEPT_ID, A.DEPT_ID
		                  FROM T_SYS_DEPT A
		                 INNER JOIN CTE C
		                    ON A.PARENT_DEPT_ID = C.DEPT_ID
		            )
		            SELECT PARENT_DEPT_ID, DEPT_ID
		              FROM CTE
		       ) C
		   SET A.DEPT_ID = ''
		 WHERE A.DEPT_ID = C.DEPT_ID
	</update>

	<delete id="delete_dept3">
		DELETE T_SYS_DEPT
		  FROM T_SYS_DEPT
		 INNER JOIN (
		            WITH RECURSIVE CTE AS (
		                SELECT #{grdParentDeptId} AS PARENT_DEPT_ID
		                     , #{grdDeptId} AS DEPT_ID
		                     , 'EX' AS CHK_COL
		                 UNION ALL
		                SELECT A.PARENT_DEPT_ID, A.DEPT_ID, 'IN' AS CHK_COL
		                  FROM T_SYS_DEPT A
		                 INNER JOIN CTE C
		                    ON A.PARENT_DEPT_ID = C.DEPT_ID
		            )
		            SELECT PARENT_DEPT_ID, DEPT_ID
		              FROM CTE
		             WHERE CHK_COL = 'IN'
		       ) C
		    ON T_SYS_DEPT.DEPT_ID = C.DEPT_ID
	</delete>
	
	
	
</mapper>