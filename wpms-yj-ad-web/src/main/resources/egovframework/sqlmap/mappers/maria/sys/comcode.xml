<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.yeongju.its.ad.core.mapper.sys.comcode">

	<select id="select_tree" parameterType="commonMap" resultType="commonMap">
		SELECT Z.PARENT, Z.ID, Z.TEXT, Z.CODE_TYPE
          FROM (
                SELECT '#' PARENT
                     , '*' ID
                     , '공통코드' TEXT
                     , 0 CODE_ORDER
                     , 'F' CODE_TYPE
                  FROM DUAL
                 UNION
                SELECT CAST(V2.PARENT_CODE_ID AS CHAR) AS PARENT
                     , V2.CODE_ID ID
                     , CONCAT(V2.CODE_NAME1 , ' [' , IFNULL(B.CODE_CNT, 0) , ']') AS TEXT
                     , CAST(V2.CODE_ORDER AS UNSIGNED) CODE_ORDER
                     , V2.CODE_TYPE
                  FROM T_SYS_COMCODE V2
                  LEFT OUTER JOIN (
                                    SELECT PARENT_CODE_ID, COUNT(CODE_ID) AS CODE_CNT
                                      FROM T_SYS_COMCODE
                                     GROUP BY PARENT_CODE_ID
                                ) B
                    ON V2.CODE_ID = B.PARENT_CODE_ID
                 WHERE V2.CODE_TYPE = 'F'
                   AND V2.USE_YN = 'Y'
             ) Z
         WHERE 1=1
         ORDER BY Z.TEXT
	</select>

	<select id="select_list" parameterType="commonMap" resultType="commonMap">
		SELECT A.PARENT_CODE_ID
             , A.CODE_ID
             , A.CODE_NAME1
             , A.CODE_NAME2
             , A.CODE_NAME3
             , A.CODE_NAME4
             , A.CODE_NAME5
             , A.CODE_COMMENT
             , A.LANG_CODE
             , A.CODE_TYPE
             , A.USE_YN
             , B.USER_NAME AS MOD_ID
             , DATE_FORMAT(A.MOD_DT, '%Y-%m-%d %H:%i:%s') MOD_DT
             , 'Y' CHECK_VALUE
             , '' STATE_COL
          FROM T_SYS_COMCODE A
          LEFT OUTER JOIN T_USER_INFO B
            ON A.MOD_ID = B.USER_ID
         WHERE A.PARENT_CODE_ID = #{hTreeCode}
 		<if test="kCodeName neq null and kCodeName neq ''" >
			AND A.CODE_NAME1 LIKE '%${kCodeName}%'
		</if>
		<if test="kUseYn neq null and kUseYn neq ''" >
			AND A.USE_YN = #{kUseYn}
		</if>
         ORDER BY A.CODE_ORDER
	</select>
	
	<insert id="insert_comcode">
		INSERT INTO T_SYS_COMCODE ( 
			PARENT_CODE_ID, CODE_ID, CODE_NAME1, CODE_NAME2
		  , CODE_NAME3, CODE_NAME4, CODE_NAME5, CODE_COMMENT, CODE_ORDER
		  , LANG_CODE, CODE_TYPE_PARENT, CODE_TYPE, USE_YN_PARENT, USE_YN
		  , REG_ID, REG_DT, MOD_ID, MOD_DT
        ) VALUES (
        	#{grdParentCodeId}, #{grdCodeId}, #{grdCodeName1}, #{grdCodeName2}
          , #{grdCodeName3}, #{grdCodeName4}, #{grdCodeName5}, #{grdCodeComment}, null
          , null, 'CODE_TYPE', #{grdCodeType}, 'USE_YN', #{grdUseYn}
          , #{userId}, NOW(), #{userId}, NOW()
        )
	</insert>
	
	<update id="update_comcode">
		UPDATE T_SYS_COMCODE
           SET CODE_NAME1 = #{grdCodeName1}
             , CODE_NAME2 = #{grdCodeName2}
             , CODE_NAME3 = #{grdCodeName3}
             , CODE_NAME4 = #{grdCodeName4}
             , CODE_NAME5 = #{grdCodeName5}
             , CODE_COMMENT = #{grdCodeComment}
             , CODE_TYPE = #{grdCodeType}
             , USE_YN = #{grdUseYn}
             , MOD_ID = #{userId}
             , MOD_DT = NOW()
         WHERE PARENT_CODE_ID = #{grdParentCodeId}
           AND CODE_ID = #{grdCodeId}
	</update>
	
	<delete id="delete_comcode">
		DELETE D1
          FROM T_SYS_COMCODE D1, (
                WITH RECURSIVE CTE AS (
                    SELECT PARENT_CODE_ID, CODE_ID
                      FROM T_SYS_COMCODE
                     WHERE PARENT_CODE_ID = #{grdParentCodeId}
                       AND CODE_ID = #{grdCodeId}
                     UNION ALL
                    SELECT A.PARENT_CODE_ID, A.CODE_ID
                      FROM CTE C
                     INNER JOIN T_SYS_COMCODE A
                        ON C.CODE_ID = A.PARENT_CODE_ID
                )
                SELECT *
                  FROM CTE C
             ) D2
         WHERE D1.PARENT_CODE_ID = D2.PARENT_CODE_ID
           AND D1.CODE_ID = D2.CODE_ID
	</delete>
	
	<update id="update_comcode_order">
		UPDATE T_SYS_COMCODE
           SET CODE_ORDER = #{index} + 1
         WHERE PARENT_CODE_ID = #{grdParentCodeId}
           AND CODE_ID = #{grdCodeId}
	</update>
	
	
</mapper>